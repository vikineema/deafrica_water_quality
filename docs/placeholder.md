
# DE Africa Water Quality Pipeline Documentation

## Overview

The DE Africa Water Quality Pipeline is a workflow that processes satellite imagery to generate annual water quality variables across Africa. The pipeline analyzes multi-sensor satellite data to produce metrics like total suspended solids (TSS), chlorophyll-a concentration, optical water types, and water frequency statistics.

## Prerequisites

### Environment Setup

```bash
# Clone the repository
git clone <deafrica_water_quality>

# Install in editable mode
cd deafrica_water_quality
pip install -e .

# Restart kernel if working on DE Africa Sandbox
```

### Requirements
- Access to DE Africa Sandbox datacube environment
- Python environment with required dependencies
- YAML configuration file for analysis parameters
- Appropriate filesystem access (local or cloud storage)

---

## Pipeline Architecture

### Stage 1: Task Generation (`wq-generate-tasks`)

Generates a list of processing tasks based on temporal range, frequency, and spatial tiles.

#### Command

```bash
!wq-generate-tasks [OPTIONS] TEMPORAL_RANGE FREQUENCY OUTPUT_FILE
```

#### Arguments
- **TEMPORAL_RANGE**: Time period in ISO format (e.g., `2020-05--P1M` for May 2020)
- **FREQUENCY**: Temporal binning interval
  - Supported: `annual`, `semiannual`, `monthly`, `fortnightly`, `weekly`
- **OUTPUT_FILE**: Path to write task list (text file with one task per line)

#### Options
- `--tile-ids`: Comma-separated tile IDs (e.g., `x188/y109,x178/y095`)
- `--tile-ids-file`: Path to file containing tile IDs
- `--place-name`: Predefined test area name (view with `wq-list-test-areas`)

**Note**: Specify exactly one of `--tile-ids`, `--tile-ids-file`, or `--place-name`. If none specified, generates tasks for all African tiles.

#### Temporal Range Behavior
If the temporal range doesn't completely cover a temporal bin, all data for the complete bin will be loaded:
- `2025-08-13--P3D` with `weekly` frequency → loads `2025-08-13--P1W`
- `2025-08-13--P1M` with `monthly` frequency → loads `2025-08--P1M` and `2025-09--P1M`

#### Output
Text file containing task IDs in format: `{temporal_id}/x{xx}/y{yy}`

Example: `2015--P1Y/x200/y034`

---

### Stage 2: Water Quality Processing (`wq-process-annual-wq-variables`)

Processes tasks to generate annual water quality variables and outputs as Cloud Optimized GeoTIFFs (COGs).

#### Command

```bash
!wq-process-annual-wq-variables [OPTIONS] OUTPUT_DIRECTORY MAX_PARALLEL_STEPS WORKER_IDX
```

#### Arguments
- **OUTPUT_DIRECTORY**: Directory for output COG files, CSVs, and STAC metadata
- **MAX_PARALLEL_STEPS**: Total number of parallel workers/pods in the workflow
- **WORKER_IDX**: Zero-indexed worker ID (determines which task subset to process)

#### Options
- `--tasks`: Comma-separated task IDs
- `--tasks-file`: Path to task file (generated by Stage 1)
- `--analysis-config`: **Required** YAML configuration file path
- `--overwrite / --no-overwrite`: Reprocess existing tasks (default: False)

**Note**: Must specify either `--tasks` or `--tasks-file`, but not both.

---

## Configuration File

### Example `cfg.yaml`

```yaml
resolution: 30  # Spatial resolution in meters

# Satellite instruments to use
instruments_to_use:
  oli_agm:    #  Landsat 8/9 OLI annual Geomedians,a cloud-free composite compiled over specific timeframes
    use: true
  oli:        # Landsat 8/9 OLI surface reflectance image collection
    use: false
  msi_agm:    # Sentinel-2 MSI annual Geomedians
    use: true
  msi:        # Sentinel-2 MSI surface reflectance image collection
    use: false
  tm_agm:     # Landsat 5 TM annual Geomedians
    use: true
  tm:         # Landsat 5 TM surface reflectance image collection
    use: false
  tirs:       # Thermal infrared sensor
    use: true
  wofs_ann:   # Annual Water Observations from Space
    use: true

# Water detection thresholds
water_frequency_threshold_high: 0.5   # High confidence water threshold
water_frequency_threshold_low: 0.1    # Low confidence water threshold
permanent_water_threshold: 0.0875     # Permanent water classification
sigma_coefficient: 1.2                # Statistical confidence parameter

# Product metadata
product:
  name: "wq_product"
  version: "1.0.0"
```

### Configuration Parameters

| Parameter | Description | Typical Range |
|-----------|-------------|---------------|
| `resolution` | Output spatial resolution (meters) | 10, 30, 60 |
| `water_frequency_threshold_high` | Minimum frequency for high-confidence water | 0.0 - 1.0 |
| `water_frequency_threshold_low` | Minimum frequency for low-confidence water | 0.0 - 1.0 |
| `permanent_water_threshold` | Threshold for permanent water classification | 0.0 - 1.0 |
| `sigma_coefficient` | Standard deviation multiplier for water confidence | 0.5 - 2.0 |

---

## Processing Workflow

### 1. Task Distribution
- Splits all tasks equally across available workers using `MAX_PARALLEL_STEPS`
- Each worker processes its assigned subset based on `WORKER_IDX`
- Unused workers automatically skip processing

### 2. Data Loading
- Validates task frequency (annual only for this command)
- Checks for existing outputs (skips if found unless `--overwrite`)
- Parses temporal range and converts to date strings
- Determines tile bounding box from grid specification
- Filters instruments based on data availability for date range
- Builds datacube queries for multi-sensor data loading
- Creates Dask cluster if running on Sandbox (detects `JUPYTERHUB_USER`)
- Loads and constructs multi-sensor/multi-temporal dataset

### 3. Water Detection & Classification
- **Water Analysis**: Identifies water pixels using WOFS frequency
  - Classifies as: sometimes water, usually water, permanent water
  - Calculates confidence intervals using sigma coefficient
- **Dark Pixel Correction**: Applies R_correction to reflectance data
- **Hue Calculation**: Computes water color hue (MSI instrument only)
- **Optical Water Type (OWT)**: Classifies water types per pixel
  - Separate classifications for MSI and OLI instruments
  - Uses 3x resampling rate for OWT determination

### 4. Water Quality Variable Calculation
- Applies algorithms to pixels meeting low water frequency threshold
- Computes variables including:
  - **TSS** (Total Suspended Solids)
  - **Chlorophyll-a** concentration
  - **Hue** values
  - **OWT classifications**
  - **WOFS statistics** (frequency, clear count, wet count, confidence)

### 5. Data Cleanup
- Retains essential variables and water quality outputs
- Drops intermediate reflectance bands and corrected values
- Standardizes all output bands to float32 data type

### 6. Output Generation

#### COG Files (per band)
- Path pattern: `{output_dir}/{product_name}/{product_version}/{temporal_id}/{tile_id}/{band_name}.tif`
- Format: Cloud Optimized GeoTIFF
- Data type: float32
- NoData value: NaN (for non-WQ variables)
- Attributes: product name, version, scale, offset

#### CSV File (water quality parameters)
- Path pattern: `{output_dir}/{product_name}/{product_version}/{temporal_id}/{tile_id}/wq_parameters.csv`
- Contains: Summary table of all computed water quality variables

#### STAC Metadata
- Path pattern: `{output_dir}/{product_name}/{product_version}/{temporal_id}/{tile_id}/metadata.stac.json`
- Includes: Source dataset UUIDs, spatial/temporal extent, band information

### 7. Error Handling
- Continues processing on task failures
- Logs failed tasks to `/tmp/failed_tasks`
- Exits with code 1 if any tasks fail, 0 if all succeed

---

## Output Data Products

### Generated Variables

#### Water Frequency & Masking Variables
| Variable | Description | Source | Units |
|----------|-------------|--------|-------|
| `wofs_ann_freq` | Annual water frequency | WOFS | 0-1 (proportion) |
| `wofs_ann_freq_sigma` | Water frequency standard deviation | WOFS | 0-1 |
| `wofs_ann_clearcount` | Number of clear observations | WOFS | count |
| `wofs_ann_wetcount` | Number of wet observations | WOFS | count |
| `wofs_ann_confidence` | Water detection confidence | Water analysis | 0-1 |
| `wofs_pw_threshold` | Permanent water threshold | Water analysis | 0-1 |
| `wofs_ann_pwater` | Permanent water flag | Water analysis | boolean |
| `wofs_ann_water` | Annual water presence flag | Water analysis | boolean |
| `watermask` | Binary water mask | Water analysis | boolean |

#### Optical Water Type Variables
| Variable | Description | Source | Units |
|----------|-------------|--------|-------|
| `owt_msi` | Optical water type classification | OWT algorithm (Sentinel-2) | class |
| `owt_oli` | Optical water type classification | OWT algorithm (Landsat) | class |

#### Chlorophyll-a (ChlA) Concentration Variables
| Variable | Description | Algorithm | Instrument | Units |
|----------|-------------|-----------|------------|-------|
| `chla_meris2b_msi_agm` | Chlorophyll-a concentration | MERIS 2-Band | Sentinel-2 MSI | μg/L |
| `chla_modis2b_msi_agm` | Chlorophyll-a concentration | MODIS 2-Band | Sentinel-2 MSI | μg/L |
| `chla_modis2b_tm_agm` | Chlorophyll-a concentration | MODIS 2-Band | Landsat TM | μg/L |
| `ndci_msi54_agm` | Normalized Difference Chlorophyll Index | NDCI (B5-B4) | Sentinel-2 MSI | index |
| `ndci_msi64_agm` | Normalized Difference Chlorophyll Index | NDCI (B6-B4) | Sentinel-2 MSI | index |
| `ndci_msi74_agm` | Normalized Difference Chlorophyll Index | NDCI (B7-B4) | Sentinel-2 MSI | index |
| `ndci_oli54_agm` | Normalized Difference Chlorophyll Index | NDCI (B5-B4) | Landsat OLI | index |
| `ndci_tm43_agm` | Normalized Difference Chlorophyll Index | NDCI (B4-B3) | Landsat TM | index |

#### Total Suspended Solids (TSS) / Turbidity Variables
| Variable | Description | Algorithm | Instrument | Units |
|----------|-------------|-----------|------------|-------|
| `tss` | Total suspended solids (stacked) | Multiple algorithms | Multi-instrument | mg/L |
| `ndssi_rg_msi_agm` | Normalized Difference Suspended Sediment Index | NDSSI (Red-Green) | Sentinel-2 MSI | index |
| `ndssi_rg_oli_agm` | Normalized Difference Suspended Sediment Index | NDSSI (Red-Green) | Landsat OLI | index |
| `ndssi_rg_tm_agm` | Normalized Difference Suspended Sediment Index | NDSSI (Red-Green) | Landsat TM | index |
| `ndssi_bnir_oli_agm` | Normalized Difference Suspended Sediment Index | NDSSI (Blue-NIR) | Landsat OLI | index |
| `ndssi_bnir_tm_agm` | Normalized Difference Suspended Sediment Index | NDSSI (Blue-NIR) | Landsat TM | index |
| `ti_yu_oli_agm` | Turbidity Index | Yu et al. | Landsat OLI | index |
| `ti_yu_tm_agm` | Turbidity Index | Yu et al. | Landsat TM | index |
| `tsm_lym_msi_agm` | Total Suspended Matter | Lymburner et al.  | Sentinel-2 MSI | mg/L |
| `tsm_lym_oli_agm` | Total Suspended Matter | Lymburner et al. | Landsat OLI | mg/L |
| `tsm_lym_tm_agm` | Total Suspended Matter | Lymburner et al. | Landsat TM | mg/L |
| `tss_zhang_msi_agm` | Total Suspended Solids | Zhang et al. | Sentinel-2 MSI | mg/L |
| `tss_zhang_oli_agm` | Total Suspended Solids | Zhang et al. | Landsat OLI | mg/L |
| `spm_qiu_msi_agm` | Suspended Particulate Matter | Zhongfeng Qiu et.al. 2013 | Sentinel-2 MSI | mg/L |
| `spm_qiu_oli_agm` | Suspended Particulate Matter | Zhongfeng Qiu et.al. 2013 | Landsat OLI | mg/L |
| `spm_qiu_tm_agm` | Suspended Particulate Matter | Zhongfeng Qiu et.al. 2013 | Landsat TM | mg/L |

#### Surface Temperature Variables
| Variable | Description | Source | Units |
|----------|-------------|--------|-------|
| `tirs_st_ann_max` | Annual maximum surface temperature | Landsat TIRS | °C or K |
| `tirs_st_ann_min` | Annual minimum surface temperature | Landsat TIRS | °C or K |



---

## Supporting Data

### Tile and Waterbody Mapping
**File**: `data/wq_tile_ids_and_waterbodies_uids.parquet`

- Maps waterbody UIDs from DE Africa Historical Extent product to tile IDs
- Shows which tiles each waterbody intersects
- **Must be updated** with each new Historical Extent product release
- **Update script**: `data/tiles_and_waterbody_uids.py`

---

## Usage Examples

### Example 1: Continental Processing

```bash
# Generate tasks for all of Africa, annual frequency for 2020
wq-generate-tasks 2020--P1Y annual /output/tasks_2020.txt

# Process with 10 parallel workers, worker 0
wq-process-annual-wq-variables \
  --tasks-file /output/tasks_2020.txt \
  --analysis-config cfg.yaml \
  /output/wq_products/ \
  10 \
  0
```

### Example 2: Test Area Processing

```bash
# Generate tasks for specific test area
wq-generate-tasks \
  --place-name "SA_smalldam1" \
  2019--P1Y annual \
  /output/SA_smalldam1_tasks.txt

# Process with single worker
wq-process-annual-wq-variables \
  --tasks-file /output/lake_victoria_tasks.txt \
  --analysis-config cfg.yaml \
  --overwrite \
  /output/wq_products/ \
  1 \
  0
```

### Example 3: Specific Tiles

```bash
# Generate tasks for specific tiles
wq-generate-tasks \
  --tile-ids "x188/y109,x178/y095" \
  2021--P1Y annual \
  /output/custom_tasks.txt

# Process with 4 parallel workers, worker 2
wq-process-annual-wq-variables \
  --tasks-file /output/custom_tasks.txt \
  --analysis-config cfg.yaml \
  /output/wq_products/ \
  4 \
  2
```
 
---

## Parallel Processing Strategy

### Worker Distribution
- Tasks are split using `numpy.array_split()` for equal distribution
- Empty chunks are filtered out
- Workers with indices exceeding available chunks automatically skip

### Example Distribution

```
Total tasks: 100
Max parallel steps: 4

Worker 0: tasks 0-24   (25 tasks)
Worker 1: tasks 25-49  (25 tasks)
Worker 2: tasks 50-74  (25 tasks)
Worker 3: tasks 75-99  (25 tasks)
```

### Optimization Tips
- Set `MAX_PARALLEL_STEPS` based on available compute resources
- Monitor memory usage with high-resolution processing
- Use cloud storage for distributed processing
- Enable Dask for memory-intensive tasks on Sandbox

---

## Troubleshooting

### Common Issues

**Issue**: Task frequency mismatch
- **Error**: `Expecting tasks with an annual frequency '1Y' not {freq}`
- **Solution**: This command only processes annual tasks. Use appropriate command for other frequencies.

**Issue**: Missing output files
- **Check**: Verify filesystem permissions for output directory
- **Check**: Ensure sufficient disk space
- **Solution**: Review logs for specific file write errors

**Issue**: Instrument data unavailable
- **Behavior**: Pipeline automatically filters out instruments without data for date range
- **Check**: Review config to ensure at least one instrument has data

**Issue**: Worker skipped
- **Message**: `Worker {idx} Skipped!`
- **Cause**: Worker index exceeds number of task chunks
- **Solution**: Normal behavior; reduce `MAX_PARALLEL_STEPS` or ignore

**Issue**: Failed tasks
- **Output**: `/tmp/failed_tasks` contains JSON array of failed task IDs
- **Solution**: Review logs for specific errors, rerun with `--tasks` option for failed tasks only

---

## Performance Considerations

- **Memory**: Increase for high-resolution (10m) or large tiles
- **Dask**: Automatically enabled on Sandbox, provides distributed computation
- **COG Writing**: In-memory COG creation reduces I/O overhead
- **Skip Logic**: Existing outputs are skipped unless `--overwrite` specified
- **Parallel Workers**: Scale based on available CPU/memory resources

---

## Related Commands

- `wq-list-test-areas`: View available predefined test area names
- `wq-generate-tiles`: Generate tile IDs for custom AOIs

---

## Version Information

Ensure compatibility between:
- Pipeline code version
- Configuration product version
- Output product version
- DE Africa Historical Extent product version (for waterbody mapping)


